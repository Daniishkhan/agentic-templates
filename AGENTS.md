# AGENTS.md — LLM Operating Manual

> Rules for any LLM agent working in this repository. Always loaded into context.
> **Stack:** Go · TypeScript (React + Vite) · PostgreSQL · Redis · Docker Compose
> **Contract bridge:** `api.yaml` → generated TS types. This is the only bridge between backend and frontend.

---

## 1) Principles

1. **Spec-first.** Change `api.yaml` first → generate → implement. No endpoint without a spec.
2. **Generated code is sacred.** Never hand-edit: `schema.sql`, `web/src/lib/api/schema.d.ts`, `internal/store/*.go`. Edit source → run generator → commit output.
3. **Type safety everywhere.** No `interface{}` in Go, no `any` in TS — unless justified. Runtime validation at all API boundaries.
4. **Local-first.** `make dev-infra && make dev` runs the full stack. No cloud accounts needed for dev.
5. **Read before you write.** Check `progress.md` → read existing code → then implement.
6. **10× not 100×.** No N+1 queries, no unbounded lists, no blocking in handlers. Paginate everything.
7. **Exceptions:** If you must violate a rule — document in PR, create follow-up ticket, log in "Known debt" in `progress.md`.

---

## 2) Truth hierarchy

```
  4 ▸ CODE + GENERATED ARTIFACTS ← always wins
      api.yaml · schema.sql · internal/ · web/src/
  3 ▸ progress.md ← what changed from the plan
  2 ▸ docs/epic.md ← planning intent (historical once built)
  1 ▸ docs/prd.md · docs/onepager.md ← business context
```

When documents conflict: code wins. Epic says a field exists but `schema.sql` doesn't have it → schema wins. Always read `progress.md` before starting any task.

---

## 3) Read protocol

**Never skip. Never assume you know the code from the epic alone.**

```
NEW STORY          BUG FIX                MODIFY ENDPOINT        RESUMING
─────────          ───────                ───────────────        ────────
1. progress.md     1. progress.md         1. progress.md         1. progress.md
2. api.yaml        2. error/test/repro    2. api.yaml            2. git log -20
3. schema.sql      3. handler + service   3. handler/service/    3. active stories
4. epic (story)    4. api.yaml               queries/tests
5. existing code   5. schema.sql          4. epic (new req)
6. existing tests
```

---

## 4) Write protocol

**After changing an API endpoint:**
`api.yaml` first → `make generate-types` → verify frontend compiles → commit

**After changing database schema:**
New migration (never edit existing) → `make migrate` → `make schema-dump` → update queries → `make generate` → commit all

**After deviating from epic:**
Add `DEV-XXX` entry to `progress.md`. Do NOT edit the epic.

**After completing a story:**
Move to "Completed" in `progress.md`. Note deviations. Log deferred work.

**Before every commit:**
`make validate` · `make lint` · `make test` — all must pass.

---

## 5) Project layout

```
cmd/api/          cmd/worker/       cmd/seed/          ← entrypoints
internal/<mod>/   handler.go  service.go  queries.sql  ← domain modules
internal/store/   *.go (GENERATED by sqlc)             ← never edit
pkg/              httputil/  errors/  middleware/       ← shared utilities (stable)
migrations/       000001_*.up.sql  000001_*.down.sql   ← append-only
web/src/features/<mod>/  Page · List · Detail · Form · hooks  ← frontend modules
web/src/lib/api/  schema.d.ts (GENERATED from api.yaml)
ui/               shadcn/ui components                 ← shared UI library
api.yaml          THE contract (OpenAPI 3.1)
schema.sql        GENERATED from migrations
progress.md       project state + deviations
docs/             epic.md · prd.md · onepager.md · architecture.md
.agents/skills/   <skill>/SKILL.md + <skill>/agents/openai.yaml
```

**Boundaries (inviolable):**

| `internal/` | Go only. No frontend concerns. |
|---|---|
| `web/` | TypeScript only. No Go imports, no direct DB. |
| `api.yaml` ↔ `web/` | Only bridge: `api.yaml` → generated types. |
| `pkg/` | Stable utilities only. No business logic. |
| Generated files | Never edit. Edit source → `make generate`. |

---

## 6) Commands

```
make dev-infra        ← start Postgres/Redis/MinIO
make dev              ← run full stack (API + web + worker)
make migrate          ← apply pending migrations
make migrate-new NAME=x  ← create migration pair
make schema-dump      ← dump schema.sql
make generate         ← ALL codegen: sqlc + schema + TS types
make generate-sqlc    ← Go from queries.sql
make generate-types   ← TS from api.yaml
make lint             ← golangci-lint + ESLint
make test             ← Go + Vitest (fast, no DB)
make test-integration ← requires running DB
make validate         ← regenerate + diff check (CI uses this)
make build            ← Go binaries + web assets
```

| After changing... | Run... |
|---|---|
| `queries.sql` | `make generate-sqlc` |
| `api.yaml` | `make generate-types` |
| New migration | `make migrate && make schema-dump && make generate-sqlc` |
| Before commit | `make validate` |

---

## 7) Key conventions

> Full patterns with code examples: `docs/conventions.md`. Below are the rules that prevent mistakes.

**Go modules** follow `handler.go → service.go → queries.sql` per module:
- Handlers: parse request, call service, format response. No business logic. Always use `pkg/httputil` helpers — never raw `w.WriteHeader()`.
- Services: business logic + orchestration. No `net/http` imports. Accept sqlc `Queries` interface for testability.
- Queries: raw SQL in `queries.sql`, sqlc generates typed Go into `internal/store/`.

**TypeScript:** Import API types from generated `schema.d.ts` — never hand-write them. Use TanStack Query for all data fetching. Use shadcn/ui from `ui/`. Handle empty, loading, and error states in every view.

**Database:** snake_case plural tables, UUID primary keys, `<entity>_id` foreign keys, `created_at`/`updated_at` timestamps, `deleted_at` for soft delete.

**API design:** Plural nouns (`/api/orders`), nesting for ownership (`/api/orders/:id/items`), actions as verbs (`POST /api/orders/:id/cancel`), always paginated (`?page=1&page_size=20`).

**API responses (no exceptions):**
```
Success:  { "data": { ... } }
List:     { "data": [...], "meta": { "page", "page_size", "total" } }
Error:    { "error": { "code": "MACHINE_READABLE", "message": "Human-readable", "details": {} } }
```
Register all error codes in `pkg/errors/codes.go`. HTTP: 200 · 201 · 400 · 401 · 403 · 404 · 409 · 422 · 429 · 500.

**Git:** `feat/US-XXX-short-name` · `fix/US-XXX-short-name` · `chore/description`. No direct commits to `main`. Small commits, rebase before merge.

---

## 8) Feature sequence

```
 1. Read    → §3 read protocol
 2. Contract → update api.yaml (spec-first)
 3. Migrate → new migration → make migrate && make schema-dump
 4. Queries → queries.sql → make generate-sqlc
 5. Service → business logic (no HTTP)
 6. Handler → wire HTTP (use httputil)
 7. Tests   → handler (happy + errors) + service (logic)
 8. Types   → make generate-types
 9. Web     → web/src/features/<mod>/ with generated types
10. E2E     → Playwright if critical journey
11. Validate → make validate
12. Track   → update progress.md
```

---

## 9) Definition of Done

- [ ] Acceptance criteria met
- [ ] Access control verified
- [ ] `api.yaml` updated for new/changed endpoints
- [ ] Generated files regenerated and committed
- [ ] Go tests: handler (happy + error) + service (if logic)
- [ ] Frontend: empty/loading/error states handled
- [ ] `make lint` + `make test` + `make validate` pass
- [ ] `progress.md` updated

---

## 10) Testing expectations

| Change | Minimum test |
|---|---|
| New endpoint | Handler: happy path + each error case |
| Business logic | Service unit test |
| State/transitions | Valid + invalid transitions |
| Idempotent endpoint | Duplicate = no side effect |
| UI feature | Component test if non-trivial |
| Bug fix | Regression test (fails before, passes after) |
| Critical journey | Playwright E2E |

Optimize for **tests that prevent breakages**, not coverage %.

---

## 11) Elevated care zones

| Zone | Risk | Verify |
|---|---|---|
| `migrations/` | Irreversible in prod | Types, nullability, indexes. Test up AND down. |
| `api.yaml` | Breaks TS client | Regenerate types, verify frontend compiles |
| `internal/auth/` | Security vulnerabilities | Test every role permutation |
| `pkg/httputil/` | Affects all endpoints | Test broadly |
| State machines | Domain invariants | Every valid + invalid transition |

**Destructive schema changes** use two-step migrations: (1) make nullable/add new column, deploy. (2) Drop old column after confirming no reads.

---

## 12) Deviation tracking

When implementation differs from epic, append to `progress.md`:

```
### DEV-XXX — Short description (YYYY-MM-DD)
Story: US-XXX
What changed: [one sentence]
Why: [one sentence]
Affected files: [list]
Epic outdated on: [which contract]
```

Deviations are append-only. Never delete. Never edit the epic — it's historical.

---

## 13) Stop the line

Pause feature work and fix immediately if: CI red on `main` · critical journey broken · generated files out of sync · migration failure · security vulnerability · data loss or duplication.

---

## 14) Never do this

- Edit generated files (`schema.sql`, `schema.d.ts`, `internal/store/*.go`)
- Update `docs/epic.md` to match code (log deviations in `progress.md`)
- Trust the epic over `api.yaml` or `schema.sql`
- Skip `make validate` before committing
- Add an endpoint without updating `api.yaml`
- Import `internal/` from `web/`
- Add a list endpoint without pagination
- Commit secrets (use `.env` + `.env.example`)
- Add dependencies without checking `go.mod` / `package.json` first
- Hand-write API types in TypeScript
- Create a module directory without checking if one exists

---

## 15) Project Skills (Required Layout)

Skills for this repo are stored at `.agents/skills/<skill-name>/` and are auto-discovered.

Each skill must include:

1. `SKILL.md` with YAML frontmatter containing:
   - `name`
   - `description`
   - `metadata.short-description`
2. `agents/openai.yaml` with:
   - `interface.display_name`
   - `interface.short_description`
   - `interface.default_prompt` (include `$<skill-name>` in the prompt text)

Rules:

- Keep metadata per skill. Do not centralize all skill metadata in one root `openai.yaml`.
- Store repo skills only under `.agents/skills/` (do not use a top-level `skills/` directory).
- Treat `.agents/skills/project-scaffold/scripts/bootstrap.sh` as the source of truth for project bootstrapping behavior.
- Use `$project-scaffold` for bootstrap tasks; reference `.agents/skills/project-scaffold/references/bootstrap.md` for verification steps.
- AGENTS scoping follows nearest-file precedence: if a nested `AGENTS.md` exists in a subtree, it overrides parent instructions for files in that subtree.
